---
- name: Prepare node for running tests
  hosts: all
  become: true
  become_method: sudo
  gather_facts: true
  tasks:
    - name: Rebooting machine
      reboot:

    - name: Ending the play now
      ansible.builtin.meta: end_play

    - name: Subscribe for fips-updates
      command: pro enable fips-updates --assume-yes

    - name: install needed packages for running tests with apt
      apt:
        name: "{{ packages }}"
        update_cache: yes
        state: latest
      vars:
        packages:
          - unzip
          - wget
          - gnupg
          - gnupg2
          - rsync
          - acl
          - git

    - name: Setup SSH keys CentOS
      authorized_key:
        user: centos
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "CentOS"

    - name: Setup SSH keys for Oracle Linux or Amazon
      authorized_key:
        user: ec2-user
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: (ansible_distribution == "OracleLinux") or (ansible_distribution == "Amazon")

    - name: Setup SSH keys Debian
      authorized_key:
        user: admin
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: (ansible_distribution == "Debian")

    - name: Setup SSH keys Ubuntu
      authorized_key:
        user: ubuntu
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: (ansible_distribution == "Ubuntu")

    - name: Ensure cloud-init does not reset networking
      copy:
        dest: /etc/cloud/cloud.cfg.d/99-disable-network-renew.cfg
        content: |
          network:
            config: disabled

    - block:
        - name: Print message before reboot
          debug:
            msg: "About to reboot machine to apply FIPS mode"

        - name: Reboot machine to apply FIPS mode
          reboot:
            msg: "Rebooting to apply FIPS mode"
            reboot_timeout: 600

      rescue:
        - name: Capture reboot failure in Jenkins
          debug:
            msg: "ERROR: Reboot failed! Host may be unreachable or FIPS broke SSH. Manual login might be needed."

      always:
        - name: Always print system uptime after reboot attempt
          command: uptime
          ignore_errors: yes
