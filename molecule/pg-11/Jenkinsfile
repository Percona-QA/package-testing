pipeline {
  agent { label 'qaserver-03' }
  parameters {
        choice(
            name: 'PLATFORM',
            description: 'For what platform (OS) need to test',
            choices: [
                'centos7',
                'debian9',
                'debian10',
                'rhel8',
                'rhel9',
                'ubuntu-bionic'
            ]
        )
  stages {
    stage('Set build name'){
            steps {
                script {
                    currentBuild.displayName = "${env.PLATFORM}"
                }
            }
        }
    stage ('Get latest code') {
      steps {
        checkout scm
      }
    }
    stage ('Setup Python virtual environment') {
      steps {
        sh '''
          export PLATFORM_NAME=$PLATFORM"
        '''
      }
        if (params.PLATFORM=='centos7'){
        sh '''
          export PLATFORM_BOX=bento/centos-7"
        '''
        }
        else if (params.PLATFORM=='debian9'){
        sh '''
          export PLATFORM_BOX=bento/debian-9"
        '''
        }
      }
    stage ('Setup Environment Variables') {
      steps {
        sh '''
        python3 -m venv virtenv
        source virtenv/bin/activate
        pip install pytest molecule ansible wheel  python-vagrant paramiko
        '''
      }
    }
    stage ('Destroy previous environment') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule destroy
         '''
        }
    }
    stage ('Create virtual machines and run playbook for test') {
      steps {
          sh '''
              export PGAUDIT="true"
              source virtenv/bin/activate
              cd molecule/pg-11
              molecule converge
           '''
     }
    }
    stage ('Start testinfra tests') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule verify
         '''
        }
    }
    stage ('Start packages deletion') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule cleanup
         '''
        }
    }
    stage ('Destroy environment') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule destroy
         '''
        }
    }
  }
   post {
        always {
            junit 'molecule/pg-11/molecule/default/*.xml'
        }
    }
}