pipeline {
  agent { label 'qaserver-03' }
  parameters {
        choice(
            name: 'PLATFORM',
            description: 'For what platform (OS) need to test',
            choices: [
                'centos7',
                'debian9',
                'debian10',
                'rhel8',
                'rhel9',
                'ubuntu-bionic'
            ]
        )
  }
  stages {
    stage('Set build name'){
      steps {
                script {
                    currentBuild.displayName = "${env.BUILD_NUMBER}-${env.PLATFORM}"
                }
            }
        }
    stage ('Get latest code') {
      steps {
        checkout scm
      }
    }
    stage ('Setup Environment Variables') {
      steps {
        sh '''
          export PLATFORM_NAME=$params.PLATFORM
        '''
       script {
        if (params.PLATFORM=='centos7'){
        sh '''
          export PLATFORM_BOX=bento/centos-7
        '''
        }
        else if (params.PLATFORM=='debian9'){
        sh '''
          export PLATFORM_BOX=bento/debian-9
        '''
        }
        else if (params.PLATFORM=='debian10'){
        env.PLATFORM_BOX = 'bento/debian-10'
        sh '''
          export PLATFORM_BOX=bento/debian-10
        '''
         }
        }
       }
      }
    stage ('Setup Python virtual environment') {
      steps {
        sh '''
        python3 -m venv virtenv
        source virtenv/bin/activate
        pip install pytest molecule ansible wheel  python-vagrant paramiko
        '''
      }
    }
    stage ('Destroy previous environment') {
      steps {
         echo "${env.PLATFORM_NAME}"
         echo "${env.PLATFORM_BOX}"
         sh '''
           echo $PLATFORM_NAME
           echo $PLATFORM_BOX
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule destroy
         '''
        }
    }
    stage ('Create virtual machines and run playbook for test') {
      steps {
          echo "${env.PLATFORM_NAME}"
          echo "${env.PLATFORM_BOX}"
          sh '''
              echo $PLATFORM_NAME
              echo $PLATFORM_BOX
              source virtenv/bin/activate
              cd molecule/pg-11
              molecule converge
           '''
     }
    }
    stage ('Start testinfra tests') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule verify
         '''
        }
    }
    stage ('Start packages deletion') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule cleanup
         '''
        }
    }
    stage ('Destroy environment') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule destroy
         '''
        }
    }
  }
   post {
        always {
            junit 'molecule/pg-11/molecule/default/*.xml'
        }
    }
}