pipeline {
  agent { label 'qaserver-03' }
  stages {
    stage ('Get latest code') {
      steps {
        checkout scm
      }
    }
    stage ('Setup Python virtual environment') {
      steps {
        sh '''
        python3 -m venv virtenv
        source virtenv/bin/activate
        pip install pytest molecule ansible wheel  python-vagrant paramiko
        '''
      }
    }
    stage ('Destroy previous environment') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule destroy
         '''
        }
    }
    stage ('Create virtual machines and run playbook for test.') {
      steps {
          sh '''
              export PGAUDIT="true"
              source virtenv/bin/activate
              cd molecule/pg-11
              molecule converge
           '''
     }
    }
    stage ('Start testinfra tests') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule verify
         '''
        }
    }
    stage ('Start packages deletion') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule side-effect
         '''
        }
    }
    stage ('Destroy environment') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule destroy
         '''
        }
    }
  }
   post {
        always {
            junit 'molecule/pg-11/molecule/default/*.xml'
        }
    }
}