---
- name: Prepare node for running tests
  hosts: all
  become: true
  become_method: sudo
  gather_facts: true
  tasks:
    - name: Setup SSH keys for RedHat
      authorized_key:
        user: ec2-user
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_os_family == "RedHat"
      
    - name: Setup SSH keys CentOS
      authorized_key:
        user: centos
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "CentOS"

    - name: Setup SSH keys for Oracle Linux or Amazon
      authorized_key:
        user: ec2-user
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "OracleLinux" or ansible_distribution == "Amazon"

    - name: Setup SSH keys Debian
      authorized_key:
        user: admin
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "Debian"

    - name: Setup SSH keys Ubuntu
      authorized_key:
        user: ubuntu
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "Ubuntu"

    - name: Install git for Debian family
      apt:
        name: git
        update_cache: yes
        state: present
      when: ansible_os_family == "Debian"

    - name: Install git for RedHat family (RHEL 7 and earlier)
      yum:
        name: git
        state: present
      when:
        - ansible_os_family == "RedHat"
        - ansible_distribution_major_version | int <= 7

    - name: Install git for RedHat family (RHEL 8 and later)
      dnf:
        name: git
        state: present
      when:
        - ansible_os_family == "RedHat"
        - ansible_distribution_major_version | int >= 8

    - name: Install python3 and python3-pip for Debian family
      apt:
        name:
          - python3
          - python3-pip
        update_cache: yes
        state: present
      when: ansible_os_family == "Debian"

    - name: Install python3 and python3-pip for RedHat family (RHEL 7 and earlier)
      yum:
        name:
          - python3
          - python3-pip
        state: present
      when:
        - ansible_os_family == "RedHat"
        - ansible_distribution_major_version | int <= 7

    - name: Install python3 and python3-pip for RedHat family (RHEL 8 and later)
      dnf:
        name:
          - python3
          - python3-pip
        state: present
      when:
        - ansible_os_family == "RedHat"
        - ansible_distribution_major_version | int >= 8

    - name: Install pytest using pip3
      pip:
        name: pytest
        executable: pip3
        state: present

    - name: Checkout server-qa repository
      git:
        repo: https://github.com/Percona-QA/server-qa.git
        dest: /server-qa
        version: tomislav-pxb-python
        force: yes
