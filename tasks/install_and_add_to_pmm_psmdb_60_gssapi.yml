# This task installs and starts Percona Server MongoDB 6.0 on Oracle Linux and Debian/Ubuntu
#
# Task adjustments are handled by parent playbook vars:
#             var "port_flag"      :  to access agent with custom port
#                                     ex: port_flag: "--pmm-agent-listen-port={{ custom_port }}"
#
- name: Download install_setup_psmdb.yml
  get_url:
    url: https://raw.githubusercontent.com/Percona-QA/psmdb-testing/main/pbm/tasks/install_setup_psmdb.yml
    dest: /tmp
    mode: 0777

- name: enable psmdb repo
  include_tasks: ./enable_repo.yml
  vars:
    package: "psmdb-60"
    repository: "release"

- name: Run install_setup_psmdb.yml
  include_tasks: /tmp/install_setup_psmdb.yml
  vars:
    psmdb_to_test: "psmdb-60"

- name: Install Kerberos
  dnf:
    name:
      - krb5-workstation
      - krb5-server
      - krb5-pkinit
    state: present
  when: ansible_os_family == "RedHat"

- name: Deploy krb5.conf from template
  template:
    src: ../templates/krb5.conf.j2
    dest: /etc/krb5.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: Setup kerberos
  shell: |
    kdb5_util -P password create -s
    kadmin.local -q "addprinc -pw password root/admin"
    kadmin.local -q "addprinc -pw mongodb mongodb/psmdb-server"
    kadmin.local -q "addprinc -pw password1 pmm-test"
    kadmin.local -q "ktadd -k /keytabs/mongodb.keytab mongodb/psmdb-server@PERCONATEST.COM"
    krb5kdc -n

- name: Generate certificates for tests
  shell: |
    rm -rf easy-rsa pki certs && mkdir certs
    git clone https://github.com/OpenVPN/easy-rsa.git
    ./easy-rsa/easyrsa3/easyrsa init-pki
    ./easy-rsa/easyrsa3/easyrsa --req-cn=Percona --batch build-ca nopass
    ./easy-rsa/easyrsa3/easyrsa --req-ou=server --subject-alt-name=DNS:pmm-server --batch build-server-full pmm-server nopass
    ./easy-rsa/easyrsa3/easyrsa --req-ou=server --subject-alt-name=DNS:psmdb-server --batch build-server-full psmdb-server nopass
    ./easy-rsa/easyrsa3/easyrsa --req-ou=client --batch build-client-full pmm-test nopass
    openssl dhparam -out certs/dhparam.pem 2048
    cp pki/ca.crt certs/ca-certs.pem
    cp pki/private/pmm-server.key certs/certificate.key
    cp pki/issued/pmm-server.crt certs/certificate.crt
    cat pki/private/psmdb-server.key pki/issued/psmdb-server.crt > certs/psmdb-server.pem
    cat pki/private/pmm-test.key pki/issued/pmm-test.crt > certs/client.pem
    find certs -type f -exec chmod 644 {} \;
    mongo --eval 'db.getSiblingDB("admin").createUser({ user: "root", pwd: "root", roles: [ "root", "userAdminAnyDatabase", "clusterAdmin" ] })'
    mongo --quiet "mongodb://root:root@localhost/?replicaSet=rs0" < ../support-files/setup_psmdb.js

- name: Read kerberos config file
  shell: cat /etc/krb5.conf
  register: result