# This task installs and starts Percona Server MongoDB 6.0 on Oracle Linux and Debian/Ubuntu
#
# Task adjustments are handled by parent playbook vars:
#             var "port_flag"      :  to access agent with custom port
#                                     ex: port_flag: "--pmm-agent-listen-port={{ custom_port }}"
#
- name: Download install_setup_psmdb.yml
  get_url:
    url: https://raw.githubusercontent.com/Percona-QA/psmdb-testing/main/pbm/tasks/install_setup_psmdb.yml
    dest: /tmp
    mode: 0777

- name: enable psmdb repo
  include_tasks: ./enable_repo.yml
  vars:
    package: "psmdb-60"
    repository: "release"

- name: Run install_setup_psmdb.yml
  include_tasks: /tmp/install_setup_psmdb.yml
  vars:
    psmdb_to_test: "psmdb-60"

- name: Install Kerberos
  dnf:
    name:
      - krb5-workstation
      - krb5-server
      - krb5-pkinit
    state: present
  when: ansible_os_family == "RedHat"

- name: Deploy krb5.conf from template
  template:
    src: ../templates/krb5.conf.j2
    dest: /etc/krb5.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: Read kerberos config file
  shell: cat /etc/krb5.conf
  register: result