
# This playbook performs checks per PMM-6592:
#   pmm-admin list output shows exporters ports
#   pmm-admin status output shows exporters ports
#   pmm-admin inventory list agents output shows exporters ports
#   reassigned port is reflected in output
#
#   must be called with "include_tasks" and "with_items, ex:
#  - name: some name for the task
#    include_tasks: ../tasks/exporter-port-output-checks.yml
#    with_items:
#      - vmagent
#      - postgres_exporter
#      - mongodb_exporter
#      - mysql_exporter

- name: "get {{ item }} port from ps"
  command: "ps aux | grep {{ item }} | grep -oP 'address=:\\K[\\d.]+'"
  register: "port_from_ps"

- name: "get {{ item }} port from pmm-admin list output"
  command: "pmm-admin list | awk '/{{ item }}/ {print $NF}'"
  register: "list_port_output"

- name: "Assert {{ item }} port output is tha same in ps and pmm-admin list"
  assert:
    that:
      - "port_from_ps = list_port_output"

- name: "get {{ item }} port from pmm-admin status output"
  command: "pmm-admin status | awk '/{{ item }}/ {print $NF}'"
  register: "status_port_output"

- name: "Assert {{ item }} port output is tha same in ps and pmm-admin status"
  assert:
    that:
      - "port_from_ps = status_port_output"

- name: "get {{ item }} port from pmm-admin inventory list agents output"
  command: "pmm-admin inventory list agents | awk '/{{ item }}/ {print $NF}'"
  register: "inventory_list_agents_port_output"

- name: "Assert {{ item }} port output is tha same in ps and pmm-admin inventory list agents"
  assert:
    that:
      - "port_from_ps = inventory_list_agents_port_output"
