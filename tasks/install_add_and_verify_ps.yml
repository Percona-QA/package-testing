# This task install Percona Serverver adds it to the pmm client and verifies that metrics hits the server.

- name:
  debug:
    var: enabled_db

- set_fact:
    mysql_service_name: "mysql_{{ instance_ip }}_{{ ansible_distribution }}_{{ ansible_distribution_major_version }}"

- name: Install and start Percona Server 5.7
  when: '"ps-5.7" in enabled_db'
  include_tasks: ../tasks/install_and_add_to_pmm_ps_57.yml

- name: Install and start Percona Server 8.0
  when: '"ps-8.0" in enabled_db'
  include_tasks: ../tasks/install_and_add_to_pmm_ps_80.yml

- name: Verify if Metric Endpoint with Auth works for Mysqld Exporter
  when: '"ps-" in enabled_db | join("")'
  include_tasks: ../tasks/verify_pmm3_metric.yml
  loop:
    - { service_name: '{{ mysql_service_name }}', metric: 'mysql_up 1' }